<!DOCTYPE html>
<html>
<head>
    <title> 作品集 | e^(πi) = 附1 </title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="res/css/loading-pre.css">
    <script src="res/js/loading-pre.js"></script>
</head>
<body>
    <div class="loading-barrier">
        <div class="loading-animation">
            <h1><span>L</span><span>o</span><span>a</span><span>d</span><span>i</span><span>n</span><span>g</span><span>.</span><span>.</span><span>.</span></h1>
        </div>
    </div>
    <div id="stage">
        <!-- 目錄  -->
        <div class="subject" id="index">
            <div class="bar">
                <nav class="navbar navbar-expand-lg navbar-light bg-light">
                    <a class="navbar-brand" href="./">  e<sup>πi</sup> = 附1  </a>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bar" aria-controls="bar" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>

                    <div class="collapse navbar-collapse" id="bar">
                        <ul class="navbar-nav mr-auto">
                            <li class="nav-item">
                                <a class="nav-link" href="./">首頁</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="./collection">研究成果</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="./message">留言區</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="./others">其他</a>
                            </li>
                        </ul>
                    </div>
                </nav>
            </div>
            <div class="sub-link" style="position: absolute; top: calc(80px + (100% - 80px) * 0.02);">
                <a href="#數學組">數學組</a>
                <img class="sub-link-icon" src="res/img/icons/math.png">
            </div>
            <div class="sub-link" style="position: absolute; top: calc(80px + (100% - 80px) * 0.15);">
                <a href="#物理組">物理組</a>
                <img class="sub-link-icon" src="res/img/icons/physics.png">
            </div>
            <div class="sub-link" style="position: absolute; top: calc(80px + (100% - 80px) * 0.28);">
                <a href="#化學組">化學組</a>
                <img class="sub-link-icon" src="res/img/icons/chemistry.png">
            </div>
            <div class="sub-link" style="position: absolute; top: calc(80px + (100% - 80px) * 0.41);">
                <a href="#生物組">生物組</a>
                <img class="sub-link-icon" src="res/img/icons/biology.png">
            </div>
            <div class="sub-link" style="position: absolute; top: calc(80px + (100% - 80px) * 0.54);">
                <a href="#地科組">地科組</a>
                <img class="sub-link-icon" src="res/img/icons/earth_science.png">
            </div>
            <div class="sub-link" style="position: absolute; top: calc(80px + (100% - 80px) * 0.67);">
                <a href="#資訊組">資訊組</a>
                <img class="sub-link-icon" src="res/img/icons/computer_science.png">
            </div>
        </div>
        <!-- 數學組  -->
        <div class="subject" id="math">
            <div class="rightArrow">
                <i class="fas fa-angle-right"></i>
            </div>
            <div class="leftArrow">
                <i class="fas fa-angle-left"></i>
            </div>
            <div class="research introduction"></div>
        </div>
        <!-- 物理組  -->
        <div class="subject" id="phy">
            <div class="rightArrow">
                <i class="fas fa-angle-right"></i>
            </div>
            <div class="leftArrow">
                <i class="fas fa-angle-left"></i>
            </div>
            <div class="research introduction"></div>
        </div>
        <!-- 化學組  -->
        <div class="subject" id="che">
            <div class="rightArrow">
                <i class="fas fa-angle-right"></i>
            </div>
            <div class="leftArrow">
                <i class="fas fa-angle-left"></i>
            </div>
            <div class="research introduction"></div>
        </div>
        <!-- 生物組  -->
        <div class="subject" id="bio">
            <div class="rightArrow">
                <i class="fas fa-angle-right"></i>
            </div>
            <div class="leftArrow">
                <i class="fas fa-angle-left"></i>
            </div>
            <div class="research introduction"></div>
        </div>
        <!-- 地科組  -->
        <div class="subject" id="esc">
            <div class="rightArrow">
                <i class="fas fa-angle-right"></i>
            </div>
            <div class="leftArrow">
                <i class="fas fa-angle-left"></i>
            </div>
            <div class="research introduction"></div>
        </div>
        <!-- 資訊組  -->
        <div class="subject" id="csc">
            <div class="rightArrow">
                <i class="fas fa-angle-right"></i>
            </div>
            <div class="leftArrow">
                <i class="fas fa-angle-left"></i>
            </div>
            <div class="research introduction"></div>
        </div>
    </div>
    <div id="full-img-viewer">
        <img id="fiv-src" title="點擊切換視角">
        <div id="fiv-wide-viewer" title="點擊切換視角">
            <img id="fiv-wv-src">
        </div>
    </div>
    <link href="https://stackpath.bootstrapcdn.com/bootswatch/4.4.1/flatly/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullPage.js/3.0.8/fullpage.min.css" />
    <link href="https://vjs.zencdn.net/7.8.2/video-js.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
    <script src="res/js/functions.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullPage.js/3.0.8/vendors/scrolloverflow.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullPage.js/3.0.8/fullpage.extensions.min.js" crossorigin="anonymous"></script>
    <script src="https://vjs.zencdn.net/7.8.2/video.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.5/firebase-firestore.js"></script>
    <script src="res/js/firebase-helper.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9" crossorigin="anonymous" defer></script>
    <style>
    body {
        background: rgba(0,0,128,.5) url("res/img/background_x2.jpg") no-repeat center;
        background-size: cover;
    }
    body::-webkit-scrollbar {
        display: none !important;
    }
    .bar {
        z-index: 3;
        position: absolute;
        top: 0;
        width: 100%;
        box-shadow: 0px 4px 8px 0px rgba(32, 32, 32, 0.3);
    }
    .sub-link {
        font-size: 8vmin;
    }
    .sub-link > a {
        color: black;
    }
    .sub-link > a:hover {
        color: rgba(0, 0, 0, .65);
        text-decoration: none;
    }
    .sub-link > a:visited {
        color: black;
        text-decoration: none;
    }
    .sub-link-icon {
        width: 15vmin;
        position: absolute;
        right: -50%;
    }
    .container {
        position: relative;
        display: flex;
        flex-flow: row nowrap;
        justify-content: space-between;
        align-items: center;
        width: calc(100vw - 12px - max(10vmin, 71.5px));
        max-width: calc(100vw - 12px - max(10vmin, 71.5px));
        height: calc((100vw - 12px - max(10vmin, 71.5px)) * 0.5625);
        max-height: 96vh;
        background-color: rgba(0, 0, 0, 0.75);
        border-radius: 6px;
    }
    .screen {
        position: relative;
        display: inline-block;
        width: calc(80% - 4px);
        height: 95%;
    }
    .screen > div {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .screen > .block {
        display: none;
        z-index: 2;
    }
    .screen > .block.release {
        display: flex;
        animation: block-fade-out .2s linear 1 forwards;
    }
    .screen > .block.active {
        display: flex;
        animation: block-fade-in .2s linear 1 forwards;
    }
    .screen > .poster {
        position: absolute;
    }
    .screen > div > video, .screen > div > img {
        position: relative;
        max-width: 100%;
        max-height: 100%;
        border-radius: min(5px, .5vw);
    }
    .Video {
        width: 100%;
        height: 90%;
    }
    .list {
        position: relative;
        display: inline-flex;
        flex-flow: column nowrap;
        justify-content: flex-start;
        width: calc(20% - 4px);
        height: 95%;
        overflow: hidden auto;
        -ms-overflow-style: none;
    }
    .list::-webkit-scrollbar {
        display: none;
    }
    .list > div {
        position: relative;
        width: calc(100% - 12px);
        height: calc(24.5% - 12px);
        margin: 6px;
        border-radius: min(10px, 1vw);
        background-color: rgba(0, 0, 0, .8);
        color: lightgray;
        font-size: min(1.6rem, 1.8vw);
        transition: box-shadow .2s, transform .2s;
        cursor: pointer;
    }
    .list > div:hover {
        box-shadow: 2px 2px 8px 0px #424242;
        transform: matrix(1.025, 0, 0, 1.025, 0, 0);
    }
    .list-icon {
        font-size: min(3rem, 5vw);
    }
    .list-text {
        margin-bottom: 2px;
    }
    .video, .board, .book, .comment, .intro-intro, .intro-index {
        display: flex;
        flex-flow: column nowrap;
        justify-content: center;
        align-items: center;
    }
    .vl {
        display: inline-block;
        border-left: 1px solid gray;
        height: 90%;
        width: 0px;
        margin: 0 4px;
    }
    .rightArrow, .leftArrow {
        z-index: 2;
        font-size: max(7vmin, 50px);
        position: absolute;
        top: calc(50% - max(3.5vmin, 25px));
        color: lightgray;
        text-shadow: 0px 0px 4px gray;
        cursor: pointer;
        transition: text-shadow .3s;
    }
    .rightArrow:hover, .leftArrow:hover {
        text-shadow: 2px 2px 10px rgb(64, 64, 64);
    }
    .rightArrow {
        right: 6px;
    }
    .leftArrow {
        left: 6px;
    }
    .qa {
        width: 100%;
        height: calc(100% - 24px);
        overflow: hidden auto;
        -ms-overflow-style: none;
    }
    ::-webkit-scrollbar {
        width: 10px;
    }
    ::-webkit-scrollbar-track {
        background: rgba(255,255,255,.2);
        border-radius: 5px;
    }
    ::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,.45);
        border-radius: 5px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: rgba(255,255,255,.7);
    }
    .question-wrap {
        width: 100%;
        text-align: center;
        margin-bottom: 12px;
    }
    .card {
        display: inline-block;
        width: 85%;
        max-width: 600px;
        text-align: left;
        padding: 4px 0;
        background-color: rgba(255,255,255,.9);
    }
    .time {
        float: left;
        color: gray;
        margin: 0 0 -2px 14px;
        font-size: 0.9rem;
    }
    .question {
        float: left;
        clear: left;
        font-size: 1.1rem;
        word-break: break-all;
        margin: 4px 16px;
        letter-spacing: .25px;
    }
    .answer {
        float: right;
        clear: both;
        font-size: 1.2rem;
        word-break: break-all;
        margin: 4px 16px;
        letter-spacing: .25px;
        color: deepskyblue;
    }
    .screen > div > img.board-image {
        cursor: pointer;
        width: 29%;
        margin: auto 1%;
        border-radius: min(5px, .5vw);
    }
    .screen > div > img.board-image-center {
        cursor: pointer;
        width: 34%;
        border-radius: min(5px, .5vw);
    }
    .screen > div > img.book-image {
        cursor: pointer;
        max-height: 90%;
        margin: auto 1%;
        border-radius: min(5px, .5vw);
    }
    #full-img-viewer {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 100;
        background: rgba(0,0,0,.8182);
        justify-content: center;
        align-items: center;
    }
    #fiv-src {
        position: relative;
        max-width: 95%;
        max-height: 95%;
        border-radius: min(5px, .5vw);
    }
    #fiv-wide-viewer {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        justify-content: center;
        align-items: flex-start;
        overflow: auto;
    }
    #fiv-wv-src {
        position: relative;
        max-width: 90%;
        border-radius: min(5px, .5vw);
    }
    .inblock-link {
        display: block;
    }
    .block-title {
        font-size: 1.4rem;
        position: absolute;
        top: calc(-1.4rem - 4px);
        left: 0;
    }
    .block-subtitle {
        font-size: 1.2rem;
        position: absolute;
        top: calc(-1.2rem - 4px);
        right: 0;
    }
    @media screen and (orientation:portrait) {
        .block-title {
            font-size: 1.4rem;
            position: absolute;
            top: calc(-2.6rem - 8px);
            left: 0;
        }
        .block-subtitle {
            font-size: 1.2rem;
            position: absolute;
            top: calc(-1.2rem - 4px);
            left: 0;
        }
        .mobile-flex-start {
            justify-content: flex-start !important;
            font-size: min(15px, 3.2vmin);
        }
        .container {
            flex-flow: column nowrap;
            justify-content: space-between;
            align-items: center;
            width: calc(100vw - 12px - max(10vmin, 71.5px));
            max-width: calc(100vw - 12px - max(10vmin, 71.5px));
            height: calc((100vw - 12px - max(10vmin, 71.5px)) * (0.5625 + 0.2 + 0.1));
            max-height: 96vh;
            background-color: rgba(0, 0, 0, 0.75);
            border-radius: 6px;
        }
        .screen {
            position: relative;
            display: inline-block;
            width: calc(100% - 4px);
            height: calc((100vw - 12px - max(10vmin, 71.5px)) * 0.5625);
        }
        .list {
            position: relative;
            display: inline-flex;
            flex-flow: row nowrap;
            justify-content: center;
            width: calc(100% - 4px);
            height: calc((100vw - 12px - max(10vmin, 71.5px)) * 0.25);
            overflow: hidden auto;
        }
        .list > div {
            position: relative;
            width: calc((100vw - 12px - max(10vmin, 71.5px)) * 0.185 * 1.4);
            height: calc((100vw - 12px - max(10vmin, 71.5px)) * 0.185);
            margin: 6px;
            border-radius: min(10px, 1vw);
            background-color: rgba(0, 0, 0, .8);
            color: lightgray;
            font-size: min(1.6rem, 3vw);
            transition: box-shadow .2s, transform .2s;
            cursor: pointer;
        }
        .vl {
            display: inline-block;
            border-top: 1px solid gray;
            border-left: 0px solid transparent;
            height: 0px;
            width: 90%;
            margin: 4px 0;
        }
    }
    @keyframes block-fade-in {
        0% {
            opacity: 0;
            display: flex;
        }
        99% {
            opacity: 1;
        }
        100% {
            opacity: 1;
            display: flex;
        }
    }
    @keyframes block-fade-out {
        0% {
            opacity: 1;
            display: flex;
        }
        99% {
            opacity: 0;
            display: flex;
        }
        100% {
            opacity: 0;
            display: none;
        }
    }
    </style>
    <script>
    if(!location.href.includes("dev")) antiCheat();
    // Main Thread
    Array.from(document.getElementsByClassName("rightArrow")).forEach(elm => {
        elm.addEventListener("click", function() {fullpage_api.moveSlideRight();});
    });
    Array.from(document.getElementsByClassName("leftArrow")).forEach(elm => {
        elm.addEventListener("click", function() {fullpage_api.moveSlideLeft();});
    });

    var helper = new firebaseHelper();
    helper.init();
    moveSubLinks();
    var switchers = [], players = [], data = {};
    var board_base = "res/img/三面板/", book_base = "res/img/摘要/";

    var meta = location.href.includes("file://") ? "https://epii.ml/res/file/data.json" : "res/file/data.json";
    console.log("[Meta Fetcher]: Progress Start.");
    fetch(meta).then(r => r.json()).then(async (_data) => {
        console.log("[Meta Fetcher]: Success.", _data);
        data = _data;
        await buildIntro();
        await buildHTML(data);
        FP();
        //console.log("[Font]: Loading Font.");
        //await loadFont();
        console.log("OK!");
        setTimeout(function() {stopLoading(document.getElementsByClassName("loading-barrier")[0])}, 200);
    });

    // Functions
    async function buildIntro() {
        let d = [
            {
                name: "數專",
                poster: "",
                file: ["res/img/intro/math/Document-page-001.jpg", "res/img/intro/math/Document-page-002.jpg"],
                team: [
                    {
                        name: "Shoot！圓錐曲線神射手",
                        link: "#數學組/1"
                    },
                    {
                        name: "圓例覺醒",
                        link: "#數學組/2"
                    },
                    {
                        name: "一層一層串起你的心",
                        link: "#數學組/3"
                    },
                    {
                        name: "Be Equal",
                        link: "#數學組/4"
                    }
                ]
            },
            {
                name: "物專",
                poster: "",
                file: ["res/img/intro/phy/Document-page-001.jpg", "res/img/intro/phy/Document-page-002.jpg"],
                team: [
                    {
                        name: "旋出新視界",
                        link: "#物理組/1"
                    },
                    {
                        name: "強制水漩渦之分析",
                        link: "#物理組/2"
                    }
                ]
            },
            {
                name: "化專",
                poster: "",
                file: ["res/img/intro/che/Document-page-001.jpg", "res/img/intro/che/Document-page-002.jpg"],
                team: [
                    {
                        name: "如何微笑",
                        link: "#化學組/1"
                    },
                    {
                        name: "2D 奈米二硫化鉬-新型汙水救星相關研究",
                        link: "#化學組/2"
                    },
                    {
                        name: "利用銅網型液晶分析法檢測空氣中微粒",
                        link: "#化學組/3"
                    }
                ]
            },
            {
                name: "生專",
                poster: "",
                file: ["res/img/intro/bio/Document-page-001.jpg", "res/img/intro/bio/Document-page-002.jpg"],
                team: [
                    {
                        name: "利用班馬魚胚胎測試Cisplatin導致的傷害及NAC的保護效果",
                        link: "#生物組/1"
                    },
                    {
                        name: "探討粒線體對果蠅卵巢生殖幹細胞維持的影響",
                        link: "#生物組/2"
                    },
                    {
                        name: "記憶猶新—Scopolamine 對斑馬魚記憶能力與社交行為的影響",
                        link: "#生物組/3"
                    },
                    {
                        name: "比較脂質體及非脂質體轉染試劑",
                        link: "#生物組/4"
                    },
                    {
                        name: "中華珈蟌水蠆環境偏好探討",
                        link: "#生物組/5"
                    },
                    {
                        name: "以蛋白質體分析探討細胞複製與分化",
                        link: "#生物組/6"
                    },
                    {
                        name: "酒精對水蚤趨光性影響之探討",
                        link: "#生物組/7"
                    }
                ]
            },
            {
                name: "地專",
                poster: "",
                file: ["res/img/intro/earth/Document-page-001.jpg", "res/img/intro/earth/Document-page-002.jpg"],
                team: [
                    {
                        name: "近岸波與單樁式離岸風電基座關係初探",
                        link: "#地科組/1"
                    },
                    {
                        name: "熱力風模擬與分析",
                        link: "#地科組/2"
                    },
                    {
                        name: "雙眼牆颱風的內眼滾動",
                        link: "#地科組/3"
                    }
                ]
            },
            {
                name: "資專",
                poster: "",
                file: ["res/img/intro/computer/Document-page-001.jpg", "res/img/intro/computer/Document-page-002.jpg"],
                team: [
                    {
                        name: "遷移學習如何建立辨識日式插畫角色之神經網路",
                        link: "#資訊組/1"
                    },
                    {
                        name: "利用 RFID 增進校園安全",
                        link: "#資訊組/2"
                    },
                    {
                        name: "用機器學習判斷文本的主觀資訊",
                        link: "#資訊組/3"
                    }
                ]
            }
        ];
        let parant = document.getElementsByClassName("introduction");
        for(let i = 0; i < parant.length; i++) {
            let container = document.createElement("div");
            let screen = document.createElement("div");
            let vl = document.createElement("div");
            let list = document.createElement("div");

            container.classList.add("container");
            screen.classList.add("screen");
            vl.classList.add("vl");
            list.classList.add("list");

            container.appendChild(screen);
            container.appendChild(vl);
            container.appendChild(list);
            parant[i].appendChild(container);

            let poster = document.createElement("div");
            poster.classList.add("poster");
            //let posterImg = document.createElement("img");
            //posterImg.src = d[i].poster;
            let big = document.createElement("h1");
            big.style.color = "white";
            big.innerHTML = d[i].name + "！";
            poster.appendChild(big);
            screen.appendChild(poster);

            let List = [itemBuilder("intro-intro"), itemBuilder("intro-index")];
            let blocks = [];

            for(let j = 0; j < 2; j++) {
                let block = document.createElement("div");
                block.classList.add("block");

                if(!j) {
                    if(typeof d[i].file == "string") d[i].file = [d[i].file];
                    let imgs = [];
                    let l = d[i].file.length;
                    for(let k = 0; k < l; k++) {
                        let img = document.createElement("img");
                        img.classList.add("book-image");
                        img.addEventListener("click", function() {
                            fiv(d[i].file, k);
                        });
                        List[0].addEventListener("click", function() {
                            img.src = d[i].file[k];
                        }, {once: true});
                        imgs.push(img);
                        block.appendChild(img);
                    }
                }
                if(j) {
                    block.style.flexDirection = "column";
                    block.style.alignItems = "flex-start";
                    block.style.justifyContent = "space-around";
                    block.style.overflowY = "auto";
                    block.classList.add("mobile-flex-start");
                    for(let k = 0; k < d[i].team.length; k++) {
                        let link = document.createElement("a");
                        link.classList.add("inblock-link");
                        link.innerHTML = d[i].team[k].name;
                        link.href = d[i].team[k].link;
                        block.appendChild(link);
                    }
                }
                screen.appendChild(block);
                blocks.push(block);
            }
            List.forEach(btn => {list.appendChild(btn)});
            new switcher(List, blocks, poster);
        }
    }

    async function buildHTML(data) {
        console.log("[Builder]: Start Building HTML.");
        var tasks = [];
        var index = 1;
        Array.from(document.getElementsByClassName("subject")).forEach(subject => {
            if(index) {
                index = !index;
                return;
            }
            console.log("[Builder]: Start Building Subject: " + subject.id);
            for(let i = 0; i < data[subject.id].length; i++) {
                console.log("[Builder]: Data Received. Task Created.", data[subject.id][i]);
                let research = document.createElement("div");
                let container = document.createElement("div");
                let screen = document.createElement("div");
                let vl = document.createElement("div");
                let list = document.createElement("div");

                research.classList.add("research");
                container.classList.add("container");
                screen.classList.add("screen");
                vl.classList.add("vl");
                list.classList.add("list");

                container.appendChild(screen);
                container.appendChild(vl);
                container.appendChild(list);
                research.appendChild(container);
                subject.appendChild(research);
                tasks.push(builder(container, data[subject.id][i]).then(() => {
                    console.log("[Builder]: Element Created.", container);
                    console.log("[Builder]: Task Finished.");
                }));
            }
        });
        await Promise.all(tasks);
        console.log("[Builder]: All HTML Elements Were Built.");
    }

    function switcher(list, target, poster = null) {
        this.list = list;
        this.target = target;
        this.tab = 0;
        this.switch = function(n) {
            if(poster) poster.style.animation = "block-fade-out .2s linear 1 forwards";
            for(let i = 0; i < target.length; i++) {
                if(i == n) {
                    setTimeout((function(self){return function(){self.target[i].classList.add("active");}})(this), 150);
                    this.list[i].style.border = "solid 1px gray";
                }
                else if(i == this.tab) {
                    this.target[i].classList.remove("active");
                    this.target[i].classList.add("release");
                    setTimeout((function(self){return function(){self.target[i].classList.remove("release");}})(this), 150);
                    this.list[i].style.border = "";
                }
            }
            this.tab = n;
        };
        for(let i = 0; i < list.length; i++) {
            this.list[i].addEventListener("click", (function(self) {return function() {self.switch(i)}})(this), false);
        }
    }

    async function builder(container, research) {
        var screen = container.getElementsByClassName("screen")[0], list = container.getElementsByClassName("list")[0];
        var blocks = [], items = [], poster = document.createElement("div"), pic = document.createElement("img");
        var title = document.createElement("h2"), subtitle = document.createElement("h3");
        title.classList.add("block-title");
        subtitle.classList.add("block-subtitle");
        switch(research.subject) {
            case "math":
                title.innerHTML = "數學組";
                break;
            case "phy":
                title.innerHTML = "物理組";
                break;
            case "che":
                title.innerHTML = "化學組";
                break;
            case "bio":
                title.innerHTML = "生物組";
                break;
            case "esc":
                title.innerHTML = "地科組";
                break;
            case "csc":
                title.innerHTML = "資訊組";
                break;
        }
        subtitle.innerHTML = research.name;
        if(research.book.exists && research.book.url) {
            let url = research.book.url;
            if(typeof url == "string") url = [url];
            let block = document.createElement("div");
            let btn = itemBuilder("book");

            block.classList.add("block");
            url.forEach(src => {
                let img = document.createElement("img");
                img.classList.add("book-image");
                img.dataset.src = book_base + src;
                img.addEventListener("click", function() {
                    fiv(book_base + src);
                });
                block.appendChild(img);
                btn.addEventListener("click", function() {
                    img.src = book_base + src;
                }, {once: true});
            });
            btn.addEventListener("click", function() {
                fiv(book_base + url[0]);
            }, {once: true});

            blocks.push(block);
            items.push(btn);
        }
        if(research.video.exists && research.video.url) {
            let block = document.createElement("div");
            let video = document.createElement("video");
            let btn = itemBuilder("video");

            video.controls = true;
            video.preload = "none";
            video.dataset.setup = JSON.stringify({
                controlBar: {
                    playbackRateMenuButton: true
                }
            });
            if(research.video.poster) video.poster = research.video.poster;
            video.classList.add("video-js", "vjs-default-skin", "vjs-big-play-centered", "Video");

            btn.addEventListener("click", function() {
                let player = videojs(video);
                player.src({
                    src: research.video.url,
                    type: "application/x-mpegURL"
                });
                video.dataset.playerId = players.length;
                players.push(player);
            }, {once: true});


            block.classList.add("block");
            block.appendChild(video);
            blocks.push(block);
            items.push(btn);
        }
        if(research.board.exists && research.board.img) {
            let block = document.createElement("div");
            let btn = itemBuilder("board");

            block.classList.add("block");
            let imgs = [];
            let l = research.board.img.length;
            for(let i = 0; i < l; i++) {
                let img = document.createElement("img");
                img.classList.add("board-image");
                if(i === 1) img.classList.add("board-image-center");
                img.addEventListener("click", function() {
                    fiv([board_base + research.board.img[i], board_base + research.board.img[(i+1)%l], board_base + research.board.img[(i+l-1)%l]]);
                });
                btn.addEventListener("click", function() {
                    img.src = board_base + research.board.img[i];
                }, {once: true});
                imgs.push(img);
                block.appendChild(img);
            }

            blocks.push(block);
            items.push(btn);
        }
        if(research.comment.exists && research.comment.id) {
            let block = document.createElement("div");
            let qa = document.createElement("div");
            let btn = itemBuilder("comment");

            block.classList.add("block");
            qa.classList.add("qa");

            let load = function() {
                qa.appendChild(cardBuilder("Loading...", "載入中，請稍後...",""));
                helper.messages.list(research.comment.id).then(list => {
                    qa.innerHTML = "";

                    let wrap = document.createElement("div");
                    let card = document.createElement("div");
                    let title = document.createElement("div");
                    let input = document.createElement("textarea");
                    let send = document.createElement("button");

                    wrap.classList.add("question-wrap");
                    card.classList.add("card");

                    title.innerHTML = "提問或留言";
                    title.style.float = "left";
                    title.style.margin = "0px 14px";
                    title.style.color = "black";
                    title.style.fontSize = "1.2rem";
                    input.rows = 2;
                    input.placeholder = "請在此寫下你的留言...";
                    input.classList.add("form-control");
                    input.style.margin = "4px 14px";
                    input.style.width = "calc(100% - 28px)";
                    send.innerHTML = "發送";
                    send.classList.add("btn", "btn-primary");
                    send.style.margin = "0px 14px";
                    send.style.float = "right";

                    send.addEventListener("click", function() {
                        Question(input.value, research.comment.id).then(() => {
                            input.value = "";
                        });
                    });

                    card.appendChild(title);
                    card.appendChild(input);
                    card.appendChild(send);
                    wrap.appendChild(card);
                    qa.appendChild(wrap);

                    list.forEach(item => {
                        if(item.response)
                        qa.appendChild(cardBuilder(item.time.toDate().toLocaleString(), item.request.replace(/\n/g, "<br>"), item.response.replace(/\n/g, "<br>")));
                    });
                });
            };
            btn.addEventListener("click", load.bind(load), {once: true});

            block.appendChild(qa);
            blocks.push(block);
            items.push(btn);
        }

        pic.src = "res/img/poster.jpg";
        poster.appendChild(pic);
        poster.classList.add("poster");

        switchers.push(new switcher(items, blocks, poster));
        
        container.appendChild(title);
        container.appendChild(subtitle);
        screen.appendChild(poster);
        for(var i = 0; i < blocks.length; i++) {
            screen.appendChild(blocks[i]);
            list.appendChild(items[i]);
        }
    }

    function cardBuilder(t="", q="", a="") {
        let wrap = document.createElement("div");
        let card = document.createElement("div");
        let time = document.createElement("div");
        let question = document.createElement("div");
        let answer = document.createElement("div");

        wrap.classList.add("question-wrap");
        card.classList.add("card");
        time.classList.add("time");
        question.classList.add("question");
        answer.classList.add("answer");

        time.innerHTML = t;
        question.innerHTML = q;
        answer.innerHTML = a;

        card.appendChild(time);
        card.appendChild(question);
        card.appendChild(answer);
        wrap.appendChild(card);
        return wrap;
    }

    function itemBuilder(type) {
        var item = document.createElement("div");
        var iconWrap = document.createElement("div");
        var icon = document.createElement("i");
        var text = document.createElement("p");
        iconWrap.classList.add("list-icon");
        text.classList.add("list-text");
        if(type == "video") {
            item.classList.add("video");
            icon.classList.add("fas", "fa-play");
            text.innerHTML = "影片";
        }
        if(type == "book") {
            item.classList.add("book");
            icon.classList.add("fas", "fa-book");
            text.innerHTML = "摘要";
        }
        if(type == "board") {
            item.classList.add("board");
            icon.classList.add("fas", "fa-chalkboard");
            text.innerHTML = "三面板";
        }
        if(type == "comment") {
            item.classList.add("comment");
            icon.classList.add("fas", "fa-comment-alt");
            text.innerHTML = "留言";
        }
        if(type == "intro-intro") {
            item.classList.add("intro-intro");
            icon.classList.add("fas", "fa-users");
            text.innerHTML = "介紹";
        }
        if(type == "intro-index") {
            item.classList.add("intro-index");
            icon.classList.add("fas", "fa-list");
            text.innerHTML = "組別";
        }
        iconWrap.appendChild(icon);
        item.appendChild(iconWrap);
        item.appendChild(text);
        return item;
    }

    function fiv(set = [], at = 0) {
        if(typeof set == "string") set = [set];
        console.log("[FIV]: Got Set.", {set, at});
        if ("ontouchstart" in document.documentElement) fullpage_api.setAllowScrolling(false);
        else fullpage_api.setAutoScrolling(false);
        document.getElementById("fiv-wide-viewer").style.display = "none";
        document.getElementById("fiv-src").style.display = "inline-block";
        document.getElementById("fiv-src").src = set[at];
        document.getElementById("fiv-wv-src").src = set[at];
        document.getElementById("full-img-viewer").style.display = "flex";
        document.getElementById("full-img-viewer").onclick = function(e) {
            if(e.target === this) {
                this.style.display = "none";
                fullpage_api.setAllowScrolling(true);
                fullpage_api.setAutoScrolling(true);
            }
        };
        document.getElementById("fiv-src").onclick = function(e) {
            this.style.display = "none";
            document.getElementById("fiv-wide-viewer").style.display = "flex";
        };
        let touchX=0;
        document.getElementById("fiv-src").ontouchstart = function(e) {
            touchX = e.touches[0].clientX;
        };
        document.getElementById("fiv-src").ontouchend = function(e) {
            let dX = e.changedTouches[0].clientX - touchX;
            touchX = 0;
            console.log("[Touch Tracer]: ", {dX});
            if(dX < 100) fiv(set, (at+1)%set.length);
            if(dX > 100) fiv(set, (at+set.length-1)%set.length);
        };
        document.getElementById("fiv-wide-viewer").onclick = function(e) {
            this.style.display = "none";
            document.getElementById("fiv-src").style.display = "inline-block";
        };
    }

    function FP() {
        window.fpc = new fullpage("#stage", {
            licenseKey: "dddddddd-dddddddd-dddddddd-dddddddd",
            anchors: ["目錄", "數學組", "物理組", "化學組", "生物組", "地科組", "資訊組"],
            autoScrolling: true,
            scrollHorizontally: true,
            sectionsColor : ["rgba(0, 0, 0, 0)", "rgba(141, 141, 239, .75)", "rgba(123, 223, 242, .75)", "rgba(178, 247, 239, .75)", "rgba(239, 247, 246, .75)", "rgba(247, 214, 224, .75)", "rgba(242, 181, 212, .75)"],
            sectionSelector: ".subject",
            slideSelector: ".research",
            controlArrows: false,
            scrollOverflow: true
        });
    }

    async function Question(q, n) {
        while(q.includes("\n\n")) {
            q = q.replace(/\n\n/g, "\n");
        }
        while(q.includes("  ")) {
            q = q.replace(/\s\s/g, " ");
        }
        console.log("[Messenger]: Questioned: \n" + q + "\nTo " + n);
        if(q.length < 5) {
            swal.fire("發送失敗", "原因：字數不足，最低限制為 5 個字", "error");
            return;
        }
        let tag = function(val) {
            var tags = [];
            switch (val) {
                case val.includes("數學_"):
                tags.push("數學專題");
                break;
                case val.includes("物理_"):
                tags.push("物理專題");
                break;
                case val.includes("化學_"):
                tags.push("化學專題");
                break;
                case val.includes("生物_"):
                tags.push("生物專題");
                break;
                case val.includes("地科_"):
                tags.push("地科專題");
                break;
                case val.includes("資訊_"):
                tags.push("資訊專題");
                break;
            }
            tags.push(val);
            return tags;
        };
        this.disabled = true;
        await helper.messages.make(q, tag(n)).then(result => {
            if(result) {
                Swal.fire("已送出！", "我們已經收到你的留言了！請稍後片刻，我們將會回覆你。", "success");
                this.disabled = false;
            }
        });
    }

    function moveSubLinks() {
        let elms = document.getElementsByClassName("sub-link");
        let icons = document.getElementsByClassName("sub-link-icon");
        for(let i = 0; i < elms.length; i++) {
            let d = Math.floor(Math.random() * 10 + 15);
            if(i%2) elms[i].style.right = d + "%";
            else elms[i].style.left = (d-7) + "%";
            icons[i].style.right = (-1 * Math.floor(Math.random() * 10 + 55)) + "%";
            icons[i].style.bottom = (-1 * Math.floor(Math.random() * 40 + 20)) + "%";
            icons[i].style.transform = `rotate(${Math.floor(Math.random() * 40 - 15)}deg)`;
        }
    }
    </script>
</body>
</html>
